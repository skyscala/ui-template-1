aW1wb3J0IHtDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnOwppbXBvcnQge05hdmlnYXRpb25FbmQsIFJvdXRlcn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJzsKaW1wb3J0IHthbmltYXRlLCBzdGF0ZSwgc3R5bGUsIHRyYW5zaXRpb24sIHRyaWdnZXJ9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnOwppbXBvcnQge1N1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7CmltcG9ydCB7ZmlsdGVyfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7CmltcG9ydCB7TWVudVNlcnZpY2V9IGZyb20gJy4vYXBwLm1lbnUuc2VydmljZSc7CmltcG9ydCB7QXBwTWFpbkNvbXBvbmVudH0gZnJvbSAnLi9hcHAubWFpbi5jb21wb25lbnQnOwoKQENvbXBvbmVudCh7CiAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgKi8KICAgIHNlbGVjdG9yOiAnW2FwcC1tZW51aXRlbV0nLAogICAgLyogdHNsaW50OmVuYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgKi8KICAgIHRlbXBsYXRlOiBgCgkJPG5nLWNvbnRhaW5lcj4KCQkJPGEgW2F0dHIuaHJlZl09Iml0ZW0udXJsIiAoY2xpY2spPSJpdGVtQ2xpY2soJGV2ZW50KSIgKm5nSWY9IighaXRlbS5yb3V0ZXJMaW5rIHx8IGl0ZW0uaXRlbXMpICYmIGl0ZW0udmlzaWJsZSAhPT0gZmFsc2UiCgkJCSAgIChtb3VzZWVudGVyKT0ib25Nb3VzZUVudGVyKCkiIChrZXlkb3duLmVudGVyKT0iaXRlbUNsaWNrKCRldmVudCkiCgkJCSAgIFthdHRyLnRhcmdldF09Iml0ZW0udGFyZ2V0IiBbYXR0ci50YWJpbmRleF09IjAiIFtuZ0NsYXNzXT0iaXRlbS5jbGFzcyIgcFJpcHBsZT4KCQkJCTxpIGNsYXNzPSJsYXlvdXQtbWVudWl0ZW0taWNvbiIgW25nQ2xhc3NdPSJpdGVtLmljb24iPjwvaT4KCQkJCTxzcGFuPnt7aXRlbS5sYWJlbH19PC9zcGFuPgoJCQkJPHNwYW4gY2xhc3M9Im1lbnVpdGVtLWJhZGdlIiBbbmdDbGFzc109Iml0ZW0uYmFkZ2VTdHlsZUNsYXNzIiAqbmdJZj0iaXRlbS5iYWRnZSI-e3tpdGVtLmJhZGdlfX08L3NwYW4-CgkJCQk8aSBjbGFzcz0icGkgcGktZncgcGktYW5nbGUtZG93biBsYXlvdXQtbWVudWl0ZW0tdG9nZ2xlciIgKm5nSWY9Iml0ZW0uaXRlbXMiPjwvaT4KCQkJPC9hPgoJCQk8YSAoY2xpY2spPSJpdGVtQ2xpY2soJGV2ZW50KSIgKG1vdXNlZW50ZXIpPSJvbk1vdXNlRW50ZXIoKSIgKm5nSWY9IihpdGVtLnJvdXRlckxpbmsgJiYgIWl0ZW0uaXRlbXMpICYmIGl0ZW0udmlzaWJsZSAhPT0gZmFsc2UiCgkJCSAgIFtyb3V0ZXJMaW5rXT0iaXRlbS5yb3V0ZXJMaW5rIiByb3V0ZXJMaW5rQWN0aXZlPSJhY3RpdmUtbWVudWl0ZW0tcm91dGVybGluayIKCQkJICAgW3JvdXRlckxpbmtBY3RpdmVPcHRpb25zXT0ie2V4YWN0OiB0cnVlfSIgW2F0dHIudGFyZ2V0XT0iaXRlbS50YXJnZXQiIFthdHRyLnRhYmluZGV4XT0iMCIgW25nQ2xhc3NdPSJpdGVtLmNsYXNzIiBwUmlwcGxlPgoJCQkJPGkgY2xhc3M9ImxheW91dC1tZW51aXRlbS1pY29uIiBbbmdDbGFzc109Iml0ZW0uaWNvbiI-PC9pPgoJCQkJPHNwYW4-e3tpdGVtLmxhYmVsfX08L3NwYW4-CgkJCQk8c3BhbiBjbGFzcz0ibWVudWl0ZW0tYmFkZ2UiIFtuZ0NsYXNzXT0iaXRlbS5iYWRnZVN0eWxlQ2xhc3MiICpuZ0lmPSJpdGVtLmJhZGdlIj57e2l0ZW0uYmFkZ2V9fTwvc3Bhbj4KCQkJCTxpIGNsYXNzPSJwaSBwaS1mdyBwaS1hbmdsZS1kb3duIGxheW91dC1tZW51aXRlbS10b2dnbGVyIiAqbmdJZj0iaXRlbS5pdGVtcyI-PC9pPgoJCQk8L2E-CgkJCTxkaXYgY2xhc3M9InN1Ym1lbnUtYXJyb3ciICpuZ0lmPSJpdGVtLml0ZW1zICYmIGl0ZW0udmlzaWJsZSAhPT0gZmFsc2UiPjwvZGl2PgoJCQk8dWwgKm5nSWY9IihpdGVtLml0ZW1zICYmIGFjdGl2ZSkgJiYgaXRlbS52aXNpYmxlICE9PSBmYWxzZSIKCQkJCVtAY2hpbGRyZW5dPSIoKGFwcC5pc1NsaW0oKXx8YXBwLmlzSG9yaXpvbnRhbCgpKSAmJiByb290KSA_IChhY3RpdmUgPyAndmlzaWJsZScgOiAnaGlkZGVuJykgOgoJCQkJKGFjdGl2ZSA_ICd2aXNpYmxlQW5pbWF0ZWQnIDogJ2hpZGRlbkFuaW1hdGVkJykiPgoJCQkJPG5nLXRlbXBsYXRlIG5nRm9yIGxldC1jaGlsZCBsZXQtaT0iaW5kZXgiIFtuZ0Zvck9mXT0iaXRlbS5pdGVtcyI-CgkJCQkJPGxpIGFwcC1tZW51aXRlbSBbaXRlbV09ImNoaWxkIiBbaW5kZXhdPSJpIiBbcGFyZW50S2V5XT0ia2V5IiBbY2xhc3NdPSJjaGlsZC5iYWRnZUNsYXNzIj48L2xpPgoJCQkJPC9uZy10ZW1wbGF0ZT4KCQkJPC91bD4KCQk8L25nLWNvbnRhaW5lcj4KICAgIGAsCiAgICBob3N0OiB7CiAgICAgICAgJ1tjbGFzcy5hY3RpdmUtbWVudWl0ZW1dJzogJ2FjdGl2ZScKICAgIH0sCiAgICBhbmltYXRpb25zOiBbCiAgICAgICAgdHJpZ2dlcignY2hpbGRyZW4nLCBbCiAgICAgICAgICAgIHN0YXRlKCd2b2lkJywgc3R5bGUoewogICAgICAgICAgICAgICAgaGVpZ2h0OiAnMHB4JywKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAKICAgICAgICAgICAgfSkpLAogICAgICAgICAgICBzdGF0ZSgnaGlkZGVuQW5pbWF0ZWQnLCBzdHlsZSh7CiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcwcHgnLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMAogICAgICAgICAgICB9KSksCiAgICAgICAgICAgIHN0YXRlKCd2aXNpYmxlQW5pbWF0ZWQnLCBzdHlsZSh7CiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcqJywKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEKICAgICAgICAgICAgfSkpLAogICAgICAgICAgICBzdGF0ZSgndmlzaWJsZScsIHN0eWxlKHsKICAgICAgICAgICAgICAgIGhlaWdodDogJyonLAogICAgICAgICAgICAgICAgJ3otaW5kZXgnOiAxMDAsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxCiAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgc3RhdGUoJ2hpZGRlbicsIHN0eWxlKHsKICAgICAgICAgICAgICAgIGhlaWdodDogJzBweCcsCiAgICAgICAgICAgICAgICAnei1pbmRleCc6ICcqJywKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAKICAgICAgICAgICAgfSkpLAogICAgICAgICAgICB0cmFuc2l0aW9uKCd2aXNpYmxlQW5pbWF0ZWQgPT4gaGlkZGVuQW5pbWF0ZWQnLCBhbmltYXRlKCc0MDBtcyBjdWJpYy1iZXppZXIoMC44NiwgMCwgMC4wNywgMSknKSksCiAgICAgICAgICAgIHRyYW5zaXRpb24oJ2hpZGRlbkFuaW1hdGVkID0-IHZpc2libGVBbmltYXRlZCcsIGFuaW1hdGUoJzQwMG1zIGN1YmljLWJlemllcigwLjg2LCAwLCAwLjA3LCAxKScpKSwKICAgICAgICAgICAgdHJhbnNpdGlvbigndm9pZCA9PiB2aXNpYmxlQW5pbWF0ZWQsIHZpc2libGVBbmltYXRlZCA9PiB2b2lkJywKICAgICAgICAgICAgICAgIGFuaW1hdGUoJzQwMG1zIGN1YmljLWJlemllcigwLjg2LCAwLCAwLjA3LCAxKScpKQogICAgICAgIF0pCiAgICBdCn0pCmV4cG9ydCBjbGFzcyBBcHBNZW51aXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHsKCiAgICBASW5wdXQoKSBpdGVtOiBhbnk7CgogICAgQElucHV0KCkgaW5kZXg6IG51bWJlcjsKCiAgICBASW5wdXQoKSByb290OiBib29sZWFuOwoKICAgIEBJbnB1dCgpIHBhcmVudEtleTogc3RyaW5nOwoKICAgIGFjdGl2ZSA9IGZhbHNlOwoKICAgIG1lbnVTb3VyY2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjsKCiAgICBtZW51UmVzZXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjsKCiAgICBrZXk6IHN0cmluZzsKCiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgYXBwOiBBcHBNYWluQ29tcG9uZW50LCBwdWJsaWMgcm91dGVyOiBSb3V0ZXIsIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIG1lbnVTZXJ2aWNlOiBNZW51U2VydmljZSkgewogICAgICAgIHRoaXMubWVudVNvdXJjZVN1YnNjcmlwdGlvbiA9IHRoaXMubWVudVNlcnZpY2UubWVudVNvdXJjZSQuc3Vic2NyaWJlKGtleSA9PiB7CiAgICAgICAgICAgIC8vIGRlYWN0aXZhdGUgY3VycmVudCBhY3RpdmUgbWVudQogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmUgJiYgdGhpcy5rZXkgIT09IGtleSAmJiBrZXkuaW5kZXhPZih0aGlzLmtleSkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5tZW51UmVzZXRTdWJzY3JpcHRpb24gPSB0aGlzLm1lbnVTZXJ2aWNlLnJlc2V0U291cmNlJC5zdWJzY3JpYmUoKCkgPT4gewogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLnJvdXRlci5ldmVudHMucGlwZShmaWx0ZXIoZXZlbnQgPT4gZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSkKICAgICAgICAgICAgLnN1YnNjcmliZShwYXJhbXMgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXBwLmlzU2xpbSgpIHx8IHRoaXMuYXBwLmlzSG9yaXpvbnRhbCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXRlbS5yb3V0ZXJMaW5rKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlU3RhdGVGcm9tUm91dGUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICB9CgogICAgbmdPbkluaXQoKSB7CiAgICAgICAgaWYgKCEodGhpcy5hcHAuaXNTbGltKCkgfHwgdGhpcy5hcHAuaXNIb3Jpem9udGFsKCkpICYmIHRoaXMuaXRlbS5yb3V0ZXJMaW5rKSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlU3RhdGVGcm9tUm91dGUoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMua2V5ID0gdGhpcy5wYXJlbnRLZXkgPyB0aGlzLnBhcmVudEtleSArICctJyArIHRoaXMuaW5kZXggOiBTdHJpbmcodGhpcy5pbmRleCk7CiAgICB9CgogICAgdXBkYXRlQWN0aXZlU3RhdGVGcm9tUm91dGUoKSB7CiAgICAgICAgdGhpcy5hY3RpdmUgPSB0aGlzLnJvdXRlci5pc0FjdGl2ZSh0aGlzLml0ZW0ucm91dGVyTGlua1swXSwgdGhpcy5pdGVtLml0ZW1zID8gZmFsc2UgOiB0cnVlKTsKICAgIH0KCiAgICBpdGVtQ2xpY2soZXZlbnQ6IEV2ZW50KSB7CiAgICAgICAgLy8gYXZvaWQgcHJvY2Vzc2luZyBkaXNhYmxlZCBpdGVtcwogICAgICAgIGlmICh0aGlzLml0ZW0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gbmF2aWdhdGUgd2l0aCBob3ZlciBpbiBob3Jpem9udGFsIG1vZGUKICAgICAgICBpZiAodGhpcy5yb290KSB7CiAgICAgICAgICAgIHRoaXMuYXBwLm1lbnVIb3ZlckFjdGl2ZSA9ICF0aGlzLmFwcC5tZW51SG92ZXJBY3RpdmU7CiAgICAgICAgfQoKICAgICAgICAvLyBub3RpZnkgb3RoZXIgaXRlbXMKICAgICAgICB0aGlzLm1lbnVTZXJ2aWNlLm9uTWVudVN0YXRlQ2hhbmdlKHRoaXMua2V5KTsKCiAgICAgICAgLy8gZXhlY3V0ZSBjb21tYW5kCiAgICAgICAgaWYgKHRoaXMuaXRlbS5jb21tYW5kKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbS5jb21tYW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudCwgaXRlbTogdGhpcy5pdGVtfSk7CiAgICAgICAgfQoKICAgICAgICAvLyB0b2dnbGUgYWN0aXZlIHN0YXRlCiAgICAgICAgaWYgKHRoaXMuaXRlbS5pdGVtcykgewogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9ICF0aGlzLmFjdGl2ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBhY3RpdmF0ZSBpdGVtCiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIHJlc2V0IGhvcml6b250YWwgbWVudQogICAgICAgICAgICBpZiAodGhpcy5hcHAuaXNTbGltKCkgfHwgdGhpcy5hcHAuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMubWVudVNlcnZpY2UucmVzZXQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5hcHAub3ZlcmxheU1lbnVBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5hcHAuc3RhdGljTWVudU1vYmlsZUFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmFwcC5tZW51SG92ZXJBY3RpdmUgPSAhdGhpcy5hcHAubWVudUhvdmVyQWN0aXZlOwogICAgICAgIH0KICAgIH0KCiAgICBvbk1vdXNlRW50ZXIoKSB7CiAgICAgICAgLy8gYWN0aXZhdGUgaXRlbSBvbiBob3ZlcgogICAgICAgIGlmICh0aGlzLnJvb3QgJiYgdGhpcy5hcHAubWVudUhvdmVyQWN0aXZlICYmICh0aGlzLmFwcC5pc0hvcml6b250YWwoKSB8fCB0aGlzLmFwcC5pc1NsaW0oKSkgJiYgdGhpcy5hcHAuaXNEZXNrdG9wKCkpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2VydmljZS5vbk1lbnVTdGF0ZUNoYW5nZSh0aGlzLmtleSk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgbmdPbkRlc3Ryb3koKSB7CiAgICAgICAgaWYgKHRoaXMubWVudVNvdXJjZVN1YnNjcmlwdGlvbikgewogICAgICAgICAgICB0aGlzLm1lbnVTb3VyY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1lbnVSZXNldFN1YnNjcmlwdGlvbikgewogICAgICAgICAgICB0aGlzLm1lbnVSZXNldFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpOwogICAgICAgIH0KICAgIH0KfQo